# EORA Q&A Service Makefile
# ================================

.PHONY: help setup run check docker-setup docker-up docker-down docker-restart clean install-deps wait-for-db migrate

# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–∫—É
help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º
	@echo "EORA Q&A Service - –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# ================================

setup: ## –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ venv, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∑–∞–ø—É—Å–∫ –ë–î, –º–∏–≥—Ä–∞—Ü–∏–∏)
	@echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
	@$(MAKE) install-deps
	@$(MAKE) copy-env
	@$(MAKE) docker-up-db
	@$(MAKE) migrate
	@echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ 'make run'"

run: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
	@echo "üèÉ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
	cd .. && uv run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

check: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
	@echo "üîç –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞..."
	./check_code.sh

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
# ========================

install-deps: ## –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	@echo "üì¶ –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
	cd .. && uv venv
	cd .. && uv sync
	@echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
# =========================

copy-env: ## –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å .env.example –≤ .env (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
	@if [ ! -f ../.env ]; then \
		echo "üìã –ö–æ–ø–∏—Ä—É–µ–º .env.example –≤ .env..."; \
		cp ../config/.env.example ../.env; \
		echo "‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ!"; \
	else \
		echo "‚ÑπÔ∏è  –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"; \
	fi

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker –∏ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
# =================================

docker-setup: ## –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Docker (setup + docker-up)
	@echo "üê≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–Ω–æ–≥–æ Docker –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
	@$(MAKE) copy-env
	@$(MAKE) docker-up
	@echo "‚úÖ Docker –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!"

docker-up: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ Docker
	@echo "üê≥ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ Docker..."
	cd .. && docker-compose -f docker/docker-compose.yml up -d
	@echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã"

docker-up-db: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ PostgreSQL –≤ Docker
	@echo "üê≥ –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL –≤ Docker..."
	cd .. && docker-compose -f docker/docker-compose.yml up -d postgres
	@echo "‚úÖ PostgreSQL –∑–∞–ø—É—â–µ–Ω"

docker-down: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ Docker —Å–µ—Ä–≤–∏—Å—ã
	@echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker —Å–µ—Ä–≤–∏—Å—ã..."
	cd .. && docker-compose -f docker/docker-compose.yml down
	@echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

docker-restart: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ Docker —Å–µ—Ä–≤–∏—Å—ã
	@$(MAKE) docker-down
	@$(MAKE) docker-up

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# ==================================

migrate: ## –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
	@echo "üîÑ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
	cd .. && uv run alembic upgrade head
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

migrate-create: ## –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-create MSG="–æ–ø–∏—Å–∞–Ω–∏–µ")
	@if [ -z "$(MSG)" ]; then \
		echo "‚ùå –£–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: make migrate-create MSG='–æ–ø–∏—Å–∞–Ω–∏–µ'"; \
		exit 1; \
	fi
	@echo "üìù –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é: $(MSG)"
	cd .. && uv run alembic revision --autogenerate -m "$(MSG)"

migrate-rollback: ## –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
	@echo "‚Ü©Ô∏è  –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é..."
	cd .. && uv run alembic downgrade -1
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–∞—á–µ–Ω–∞"

# –£—Ç–∏–ª–∏—Ç—ã
# ========

clean: ## –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
	@echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
	cd .. && find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	cd .. && find . -type f -name "*.pyc" -delete 2>/dev/null || true
	cd .. && find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	cd .. && find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
	@echo "üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
	@tail -f ../logs/eora.log

logs-errors: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
	@echo "üö® –õ–æ–≥–∏ –æ—à–∏–±–æ–∫:"
	@tail -f ../logs/eora_errors.log

status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å Docker —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "üìä –°—Ç–∞—Ç—É—Å Docker —Å–µ—Ä–≤–∏—Å–æ–≤:"
	cd .. && docker-compose -f docker/docker-compose.yml ps

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# =======================

dev: ## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (setup + run)
	@$(MAKE) setup
	@echo ""
	@echo "üéØ –¢–µ–ø–µ—Ä—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"
	@echo "   –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ 'make run' –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"

test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
	@echo "üß™ –¢–µ—Å—Ç—ã –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã"
	@echo "TODO: –î–æ–±–∞–≤–∏—Ç—å pytest –∏ —Ç–µ—Å—Ç—ã"

# –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
# ======================

info: ## –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
	@echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ EORA Q&A Service:"
	@echo ""
	@echo "üåê –û—Å–Ω–æ–≤–Ω—ã–µ URL:"
	@echo "   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: http://localhost:8000"
	@echo "   - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs"
	@echo "   - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/redoc"
	@echo "   - Health check: http://localhost:8000/api/v1/health/"
	@echo ""
	@echo "üê≥ Docker —Å–µ—Ä–≤–∏—Å—ã:"
	@echo "   - PostgreSQL: localhost:5432"
	@echo "   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: localhost:8000 (—Ç–æ–ª—å–∫–æ –≤ docker-up)"
	@echo ""
	@echo "üìÅ –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:"
	@echo "   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: .env"
	@echo "   - –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: logs/eora.log"
	@echo "   - –õ–æ–≥–∏ –æ—à–∏–±–æ–∫: logs/eora_errors.log"
	@echo ""
	@echo "üõ†  –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "   make setup      - –ø–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "   make run        - –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
	@echo "   make check      - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞"
	@echo "   make docker-up  - –∑–∞–ø—É—Å–∫ –≤ Docker"
	@echo "   make help       - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º"
